{% comment %}
Pop Up Info:
  - flaoting window that is centered on the screen for both mobile and desktop
  - appears on page load
  - has a white background with a blue border and shadow
  - interactions:
    - clicking outside the popup closes it
    - clicking the "Nah, I Hate Deals" text closes it
    - clicking the "SHOP ALL STYLES" button takes user to the shop page and adds the code goodr5 to their cart
    - esc key also closes the popup
    - Be able to still tab around the screen
    - Clicking the x at the top right closes popup
    - Hover button response as if it is being pushed in(desktop only) 
Contents:
  - Colors
    - White #FFFFFF
    - Navy #0C2340
    - Pink #E06287
    - Yellow #EDE939
  - Font: Gibson (loaded from adobe fonts)

{% endcomment %}

{% style %}
  /* loading Gibson from adobe fonts */
  @import url('https://use.typekit.net/xci7pdj.css');

  /* existing styles follow */
  .goodr5-overlay, .goodr5-modal {
    font-family: "canada-type-gibson", sans-serif;
    box-sizing: border-box;
  }
  ...
{% endstyle %}

{%- if section.settings.show_popup -%}

  <div id="goodr5PopupOverlay" class="goodr5-overlay">
    
    <div class="goodr5-modal">
        
        <button id="goodr5CloseIcon" class="goodr5-close-icon" aria-label="Close popup">
          <img src="{{ 'x.svg' | asset_url }}" alt="Close" width="20" height="20" />
        </button>
      
      <div class="goodr5-image-container">
        <picture>
          <source media="(min-width: 768px)" srcset="{{ 'desktopimage.png' | asset_url }}">

          <!-- Mobile image: fixed rendered size 252x342 (set attributes to match displayed size) -->
          <img src="{{ 'mobileimage.png' | asset_url }}" alt="Promo Background" class="goodr5-bg-img" width="252" height="342" loading="eager" decoding="async">
        </picture>

        <div class="goodr-logo-wrapper">
        
          <img class="goodr-logo goodr-logo--mobile" src="{{ 'goodrlogo.svg' | asset_url }}" alt="goodr Logo" width="150" height="54" loading="eager" decoding="async">

          
          <img class="goodr-logo goodr-logo--desktop" src="{{ 'goodrlogo.svg' | asset_url }}" alt="goodr Logo" width="200" height="72" loading="eager" decoding="async">
        </div>
      </div>

      <div class="goodr5-text-content">
        <p>USE CODE <span class="goodr5-highlight">goodr5</span> FOR $5 OFF YOUR FIRST ORDER</p>
      </div>

      <div class="goodr5-actions">
        <button id="goodr5ShopBtn" class="goodr5-btn">
        <span class="goodr5-btn-text">SHOP ALL STYLES</span>
        </button>
        
        <a href="#" id="goodr5CloseLink" class="goodr5-close-link">Nah, I Hate Deals</a>
      </div>

    </div>
  </div>

  {% style %}
    /* --- OVERLAY --- */
    .goodr5-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      display: flex; 
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: visible;
      transition: opacity 0.3s ease;
    }

    .goodr5-overlay.is-visible {
      opacity: 1;
    }

    /* --- MODAL BOX --- */
    .goodr5-modal {
      background-color: #FFFFFF;
      border: 2px solid #0C2340;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    /* --- MOBILE STYLES (< 768px) --- */
    .goodr5-modal {
      width: 326px;
      height: 550px;
      border-radius: 4px;
      box-shadow: -2.75px 2.75px 0px 0px #0C2340;
      padding: 35px 37px;
    }

    .goodr5-image-container {
      position: relative;
      width: 252px;
      height: 342px;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 14px;
    }

    .goodr5-bg-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .goodr-logo-wrapper {
      position: absolute;
      top: 43%;
      left: 20%;
      text-align: center;
      pointer-events: none;
    }
    
    /* Default: show mobile logo, hide desktop logo */
    .goodr-logo { 
      display: none;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }
    .goodr-logo--mobile { display: block; width: 150px; height: 54.16px; }
    .goodr-logo--desktop { display: none; }

    @media (min-width: 768px) {
      /* On desktop show the desktop logo with specified size */
      .goodr-logo--mobile { display: none; }
      .goodr-logo--desktop { display: block; width: 200px; height: 72.21px; }
    }

    .goodr5-text-content {
      width: 252px;
      text-align: center;
      color: #0C2340;
      font-size: 18px;
      font-weight: 700;
      line-height: 20px;
      text-transform: uppercase;
      margin-bottom: 16px;
    }

    /* stack and center elements */
    .goodr5-actions {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Remove default P margins */
    .goodr5-text-content p {
        margin: 0;
    }

    .goodr5-highlight {
      color: #E06287;
    }

    .goodr5-btn {
      width: 252px;
      height: 40px;
      padding: 12px 81.49px;
      background-color: #EDE939;
      border-radius: 25px;
      border: 2px solid #0C2340;
      box-shadow: -2.69px 2.69px 0px 0px #0C2340;
      cursor: pointer;
      color: #FFFFFF;
      font-family: "canada-type-gibson", sans-serif;
      font-size: 14px;
      font-weight: 900;
      text-transform: uppercase;
      -webkit-text-stroke: 0.67px #0C2340;
      text-shadow: -2.5px 1.5px 0  #0C2340; 
      white-space: nowrap;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 16px;
    }

    /* Nudge the button label up slightly */
    .goodr5-btn .goodr5-btn-text {
      display: inline-block;
      transform: translateY(-5%);
      will-change: transform;
    }

    .goodr5-btn:hover {
      transform: translate(-1px, 1px);
      box-shadow: -1px 1px 0px 0px #0C2340;
    }

    .goodr5-close-link {
      font-size: 14px;
      font-weight: 700;
      color: #0C2340;
      text-decoration: underline;
      text-transform: uppercase;
      cursor: pointer;
    }

    /* Close icon styles (positioned relative to .goodr5-modal) */
    .goodr5-close-icon {
      position: absolute;
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
      display: inline-block;
      /* Mobile default size and position */
      width: 16.16px;
      height: 16.16px;
      top: 13.27px;
      left: 295.69px;
      z-index: 3;
    }

    .goodr5-close-icon img {
      width: 100%;
      height: 100%;
      display: block;
      color: #0C2340;
    }

    /* --- DESKTOP STYLES (>= 768px) --- */
    @media (min-width: 768px) {
      .goodr5-modal {
        width: 484px;
        height: 654px;
        border-width: 3px;
        border-radius: 8px;
        box-shadow: -4px 4px 0px 0px #0C2340;
        padding: 52px 55px;
      }

      .goodr5-image-container {
        width: 374px;
        height: 360px;
        margin-bottom: 20px;
      }

      .goodr-logo-wrapper {
      position: absolute;
      top: 41%;
      left: 23.5%;
      text-align: center;
      pointer-events: none;
    }

      .goodr5-text-content {
        width: 374px;
        font-size: 24px;
        line-height: 28px;
        margin-bottom: 36px;
      }

      .goodr5-btn { 
        width: 374px;
        height: 42px; 
        padding: 12px 121px;
        border-width: 2px;
        box-shadow: -4px 4px 0px 0px #0C2340;
        font-size: 18px;
        margin-bottom: 18px;
        -webkit-text-stroke: 1px #0C2340;
        text-shadow: -2.8px 2.15px 0 #0C2340; 
      }

      .goodr5-close-link {
        font-size: 18px;
      }

      /* Desktop close icon overrides */
      .goodr5-close-icon {
        width: 20px;
        height: 20px;
        top: 21.71px;
        left: 441.04px;
      }
    }
  {% endstyle %}

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const popupOverlay = document.getElementById('goodr5PopupOverlay');
      const shopBtn = document.getElementById('goodr5ShopBtn');
      const closeLink = document.getElementById('goodr5CloseLink');

      // ==== COOKIE MANAGEMENT FOR PERSISTENT DISMISS ====
      const DISMISS_COOKIE_NAME = 'goodr5_popup_dismissed';

      // Function to set a cookie (session cookie - expires when browser closes)
      function setCookie(name, value, days) {
        let cookieString = name + "=" + value + ";path=/";
        
        // Only set expiration if days is provided
        if (days) {
          const date = new Date();
          date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
          cookieString += ";expires=" + date.toUTCString();
        }
        
        document.cookie = cookieString;
        console.log('üç™ Cookie set (session):', name, '=', value);
      }

      // Function to get a cookie value
      function getCookie(name) {
        const nameEQ = name + "=";
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          let cookie = cookies[i].trim();
          if (cookie.indexOf(nameEQ) === 0) {
            return cookie.substring(nameEQ.length, cookie.length);
          }
        }
        return null;
      }

      // Function to mark popup as dismissed and set cookie
      function dismissPopup() {
        const dismissedAt = new Date().toISOString();
        setCookie(DISMISS_COOKIE_NAME, dismissedAt); // Session cookie - no expiration param needed
        console.log('Popup dismissed at:', dismissedAt);
      }

      // ==== EVENT LOGGING & FAKE DATABASE ====
      const FAKE_DATABASE_ENDPOINT = '/fake-api/popup-events'; // Fake endpoint for event tracking

      // Function to get or create a session ID
      function getSessionId() {
        let sessionId = sessionStorage.getItem('goodr5_session_id');
        if (!sessionId) {
          sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          sessionStorage.setItem('goodr5_session_id', sessionId);
        }
        return sessionId;
      }

      // Function to log event to fake database
      function logEventToDB(eventType) {
        const timestamp = new Date().toISOString();
        const eventData = {
          event_type: eventType,
          timestamp: timestamp,
          session_id: getSessionId(),
          page_url: window.location.href,
          user_agent: navigator.userAgent
        };

        // Log to console for debugging
        console.log('Popup Event Logged:', eventData);

        // Store in localStorage as backup
        const events = JSON.parse(localStorage.getItem('goodr5_events') || '[]');
        events.push(eventData);
        localStorage.setItem('goodr5_events', JSON.stringify(events));

        // POST to fake database endpoint
        fetch(FAKE_DATABASE_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(eventData)
        })
        .catch(error => {
          // Gracefully handle if endpoint doesn't exist (expected for fake DB)
          console.log('Event stored locally (fake DB endpoint not available):', eventType);
        });
      }

      // ==== CHECK FOR EXISTING DISMISSAL ====
      const isDismissed = getCookie(DISMISS_COOKIE_NAME);
      if (isDismissed) {
        console.log('Popup already dismissed. Hiding popup.');
        popupOverlay.style.display = 'none';
        return; // Exit early, don't set up event listeners
      }

      // Log popup impression
      logEventToDB('popup_impression');

      // OPEN: After 500ms delay
      setTimeout(() => {
        popupOverlay.classList.add('is-visible');
        logEventToDB('popup_displayed');
      }, 500);

      // CLOSE Function
      function closePopup() {
        popupOverlay.classList.remove('is-visible');
        setTimeout(() => {
           popupOverlay.style.display = 'none';
        }, 300);
      }

      // Interaction: Click "Nah"
      closeLink.addEventListener('click', function(e) {
        e.preventDefault();
        logEventToDB('close_link_clicked');
        dismissPopup();
        closePopup();
      });

      // Interaction: Click Outside
      popupOverlay.addEventListener('click', function(e) {
        if (e.target === popupOverlay) {
          logEventToDB('overlay_clicked');
          dismissPopup();
          closePopup();
        }
      });

      // Interaction: ESC Key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && popupOverlay.classList.contains('is-visible')) {
          logEventToDB('escape_key_pressed');
          dismissPopup();
          closePopup();
        }
      });

      // Function to check if discount code exists
      function checkDiscountExists(discountCode) {
        return fetch('/cdn/shop/t/' + Shopify.Shop.id + '/cdn/shop/discount_codes.json?code=' + discountCode)
          .then(response => {
            // If response is ok, discount exists
            if (response.ok) {
              return true;
            }
            // Try alternative method: fetch from cart endpoint
            return fetch('/cart.json')
              .then(cartResponse => cartResponse.json())
              .then(cartData => {
                // If cart endpoint works, we can safely assume discounts are available
                return true;
              })
              .catch(() => false);
          })
          .catch(() => {
            // If both fail, log and continue anyway (graceful fallback)
            console.warn('Could not verify discount, proceeding anyway');
            return true;
          });
      }

      // Interaction: Shop Button
      shopBtn.addEventListener('click', function() {
        logEventToDB('shop_button_clicked');
        dismissPopup();
        window.location.href = '/discount/goodr5?redirect=/collections/all';
        
        {% comment %} 
         checkDiscountExists('goodr5').then(exists => {
          if (exists) {
            console.log('Discount code verified, redirecting...');
            window.location.href = '/discount/goodr5?redirect=/collections/all';
          } else {
            console.warn('Discount code not found, redirecting to shop without code');
            window.location.href = '/collections/all';
          }
        }); 
        {% endcomment %}
      });

      // Interaction: Close icon
      const closeIcon = document.getElementById('goodr5CloseIcon');
      if (closeIcon) {
        closeIcon.addEventListener('click', function(e) {
          e.preventDefault();
          logEventToDB('close_icon_clicked');
          dismissPopup();
          closePopup();
        });
      }
    });
  </script>

{%- endif -%}

{% schema %}
{
  "name": "GOODR5 Pop Up",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_popup",
      "label": "Enable Pop Up",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "GOODR5 Pop Up",
    }
  ]
}
{% endschema %}












  

